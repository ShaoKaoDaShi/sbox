#!/usr/bin/env node

import fs from "node:fs/promises";
import path from "node:path";

const cwd = process.cwd();

async function removeNodeModules(dir) {
  let entries;
  try {
    entries = await fs.readdir(dir, { withFileTypes: true });
  } catch (err) {
    if (err.code === "EACCES" || err.code === "EPERM") {
      console.warn(`âš ï¸  Permission denied: ${dir}`);
      return;
    }
    throw err;
  }

  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);

    if (entry.isDirectory()) {
      if (entry.name === "node_modules") {
        console.log(`ðŸ—‘ï¸  Deleting: ${fullPath}`);
        try {
          await fs.rm(fullPath, { recursive: true, force: true });
          console.log(`âœ… Deleted: ${fullPath}`);
        } catch (err) {
          console.error(`âŒ Failed to delete ${fullPath}: ${err.message}`);
        }
        // Do not recurse into deleted directory
        continue;
      } else {
        // Recurse into subdirectories
        await removeNodeModules(fullPath);
      }
    }
  }
}

const main = async () => {
  console.log(`ðŸš€ Starting cleanup in: ${cwd}`);
  try {
    await removeNodeModules(cwd);
    console.log("âœ¨ Cleanup complete!");
  } catch (err) {
    console.error("Fatal error:", err);
    process.exit(1);
  }
};

export default main;
